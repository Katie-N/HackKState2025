<HTML>
<head>
    <title>Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./styles/style.css">
    <!-- Load fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body class="backgroundOfBody">
    <div class="banner" id="banner">
        <button id="goToCalendar" onclick="goToCalendar()"><img src="./assets/icons/calendarIcon.jpg"></button>
        <div>
            <h1>How Many Stars?</h1>
            <h2>10/17/2025</h2>
        </div>
        <button id="sendToFirestore"><img src="./assets/icons/floppyDisc.jpg"></button>
    </div>
    <div id="calendarScreen">
        <div id="calendar" onclick="goToDiary()"></div>
    </div>
    <div id="diaryEntryScreen">
        <div id="widgetDisplayArea">
            <ul id="widgetsForDay">
                <!-- Widgets will be added here dynamically -->
                 <li class="emptyWidget widget-base widget-container"></li>
            </ul>
        </div>
        <ul id="widgetSelection">
            <li><img src="./assets/icons/cameraIcon.png">Image</li>
            <li><img src="./assets/icons/notepadIcon.png">Note</li>
            <!-- <li>Weather</li> -->
            <li><img src="./assets/icons/music-playerIcon.png">Song</li>
        </ul>
    </div>
   <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

   <script src="./scripts/script.js"></script>
   <script src="./scripts/audio.js"></script>
   <!-- <script src="./scripts/fittext.js"></script>
   <script>
    window.fitText( document.getElementById("bannerh1"), 1.5 );
    </script> -->
    <!-- <script type="module" src="./scripts/firebaseApp.js"></script> -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyDy_MUOgD-8EpwDC3dwz4X0AxiOzc99O9I",
        authDomain: "hack-kstate-2025-database.firebaseapp.com",
        projectId: "hack-kstate-2025-database",
        storageBucket: "hack-kstate-2025-database.firebasestorage.app",
        messagingSenderId: "309828879233",
        appId: "1:309828879233:web:a65e6c86cabd474a455e80",
        measurementId: "G-RZCN86FE9C"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        const db = getFirestore(app);
        const storage = getStorage(app);

        // Function to handle image upload
        async function uploadImageToFirebase(file) {
            try {
                // Create a unique filename using timestamp
                const timestamp = new Date().getTime();
                const filename = `${timestamp}_${file.name}`;
                
                // Create a storage reference
                const storageRef = ref(storage, 'images/' + filename);
                
                // Upload the file
                const snapshot = await uploadBytes(storageRef, file);
                console.log('Uploaded image successfully!');
                
                // Get the download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log('File available at:', downloadURL);
                
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Make the upload function available globally
        window.uploadImageToFirebase = uploadImageToFirebase;

        // Pull diary entry from firestore for specific day
        // Do this once when the diary entry is clicked on. 
        let docRef = doc(db, "diaryEntries", "10-18-2025");
        let docSnap = await getDoc(docRef);

        // If the diary entry for this day already exists, populate
        if (docSnap.exists()) {
            // Get the references to widgets for thos entry
            let references = docSnap.data()
            // Loop through each referenced object and create an HTML element for it
            for (let key in references) {
                let collection = references[key].parent.id
                docRef = doc(db, collection, references[key].id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    references[key] = docSnap.data()
                } else {
                    console.log("No such document for widget reference:", references[key]);
                    continue
                }
                console.log(references[key])
                let widgetElement = transformWidgetToElement(key, references[key])
                document.getElementById("widgetsForDay").appendChild(widgetElement)
                
            }
            // Always move the empty widget to the end.
            let widgetsForDays = document.getElementById("widgetsForDay")
            let el = widgetsForDays.querySelector(".emptyWidget") 
            widgetsForDays.appendChild(el);
        } else {
        console.log("No such document!");
        // No data for this so default go to creation mode. 
        }

        function extractWidgetData(widgetElement) {
            let widgetData = {}
            widgetData.rating = widgetElement.querySelector(".starRating").getAttribute("data-rating")
            if (widgetElement.classList.contains("image-widget")) {
                widgetData.widgetType = "picture"
                widgetData.imageURL = widgetElement.querySelector("img").src
                widgetData.photoFrame = "plain" // TODO: get photo frame type
            } else if (widgetElement.classList.contains("note-widget")) {
                widgetData.widgetType = "note"
                widgetData.text = widgetElement.querySelector("textarea").value
                widgetData.noteType = widgetElement.querySelector()
                // Widget Type depends on what class is applied to the note widget. 
                if (widgetElement.classList.contains("notebookPaper")) {
                    widgetData.noteType = "notebookPaper";
                } else if (widgetElement.classList.contains("post-it")) {
                    widgetData.noteType = "stickyNote"
                } else {
                    widgetData.noteType = "plain"
                }
            } else if (widgetElement.classList.contains("song-widget")) {
                widgetData.widgetType = "song"
                widgetData.songURL = widgetElement.querySelector("input").value
                audioPlayer = "plain"
            }
            console.log(widgetData)
            return widgetData
        }

        // TODO: push diary entry to firestore for specific day
        function saveDiaryEntryToFirestore() {
            // First, loop through all of the elements in the diary entry and extract the widget info. 
            for (let widgetElement of document.getElementById("widgetsForDay").children) {
                // Skip empty widget
                if (widgetElement.classList.contains("emptyWidget")) {
                    continue
                }
                let widgetData = extractWidgetData(widgetElement)
                console.log(widgetData)
            }

            // Then for each widget, create a new document in the appropriate collection and get the reference.

            // Finally, create or update the diary entry document with the references to each widget.
        }        
        document.getElementById("sendToFirestore").addEventListener("click", saveDiaryEntryToFirestore);
    </script>
    <!-- <script>
        const myCustomDataEvent = new CustomEvent('saveDiaryEntry', {
            detail: {
                message: 'Hello from custom event!',
                timestamp: Date.now()
            }
        });
        document.getElementById("sendToFirestore").dispatchEvent(myCustomDataEvent);
        saveDiaryToFirestore("help me")
    </script> -->

</body>
</HTML>