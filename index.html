<HTML>
<head>
    <title>
        ⭐How Many Stars?⭐
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./styles/style.css">
    <!-- Load fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body class="backgroundOfBody">
    <div class="banner" id="banner">
        <button id="goToCalendar" onclick="goToCalendar()"><img src="./assets/icons/calendarIcon.jpg"></button>
        <div>
            <h1>How Many Stars?</h1>
            <h2 id="dateIdentifierHeading">October</h2>
        </div>
        <button id="sendToFirestore"><img src="./assets/icons/floppyDisc.jpg"></button>
    </div>
    <div id="calendarScreen">
        <div id="calendar"></div>
    </div>
    <div id="diaryEntryScreen">
        <div id="widgetDisplayArea">
            <ul id="widgetsForDay">
                <!-- Widgets will be added here dynamically -->
                 <li class="emptyWidget widget-base widget-container"></li>
            </ul>
        </div>
        <ul id="widgetSelection">
            <li><img src="./assets/icons/cameraIcon.png">Image</li>
            <li><img src="./assets/icons/notepadIcon.png">Note</li>
            <!-- <li>Weather</li> -->
            <li><img src="./assets/icons/music-playerIcon.png">Song</li>
        </ul>
    </div>

    <!-- All of the many scripts are below -->
   <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

   <script src="./scripts/audio.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getFirestore, doc, setDoc, collection, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyDy_MUOgD-8EpwDC3dwz4X0AxiOzc99O9I",
        authDomain: "hack-kstate-2025-database.firebaseapp.com",
        projectId: "hack-kstate-2025-database",
        storageBucket: "hack-kstate-2025-database.firebasestorage.app",
        messagingSenderId: "309828879233",
        appId: "1:309828879233:web:a65e6c86cabd474a455e80",
        measurementId: "G-RZCN86FE9C"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        const db = getFirestore(app);
        const storage = getStorage(app);
        //console.log(db);

        // Function to handle image upload
        async function uploadImageToFirebase(file) {
            try {
                // Create a unique filename using timestamp
                const timestamp = new Date().getTime();
                const filename = `${timestamp}_${file.name}`;
                
                // Create a storage reference
                const storageRef = ref(storage, 'images/' + filename);
                
                // Upload the file
                const snapshot = await uploadBytes(storageRef, file);
                console.log('Uploaded image successfully!');
                
                // Get the download URL
                const downloadURL = await getDownloadURL(snapshot.ref);
                console.log('File available at:', downloadURL);
                
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Make the upload function available globally
        window.uploadImageToFirebase = uploadImageToFirebase;

        // This function takes a date in the format "MM-DD-YYYY"
        // And populates the widgets with the corresponding diary entry from firestore
        // If the diary entry does not exist yet, it leaves the widgets area blank for creation.
        async function pullDiaryEntryFromFirestore(date){
            console.log("Pulling diary entry from firestore");
            // Pull diary entry from firestore for specific day
            // Do this once when the diary entry is clicked on. 
            let docRef = doc(db, "diaryEntries", date);
            let docSnap = await getDoc(docRef);

            // If the diary entry for this day already exists, populate
            if (docSnap.exists()) {
                // Get the references to widgets for thos entry
                let references = docSnap.data()
                //rating variables
                let averageRating = 0;
                let i = 0
                let rating = 0;

                // Loop through each referenced object and create an HTML element for it
                for (let key in references) {
                    let collection = references[key].parent.id
                    docRef = doc(db, collection, references[key].id);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        references[key] = docSnap.data()
                    } else {
                        console.log("No such document for widget reference:", references[key]);
                        continue
                    }
                    console.log(references[key])

                    rating += references[key].rating;
                    i += 1;

                    let widgetElement = transformWidgetToElement(key, references[key])
                    document.getElementById("widgetsForDay").appendChild(widgetElement)
                    
                }   
                averageRating = rating / i;
                averageRating = Math.round(averageRating * 10) / 10; // Round to 1 decimal place
                document.getElementById("dateIdentifierHeading").innerText = `${date}: ⭐${averageRating}`
                console.log("Average rating for the day:", averageRating);     
                // Always move the empty widget to the end.
                let widgetsForDays = document.getElementById("widgetsForDay")
                let el = widgetsForDays.querySelector(".emptyWidget") 
                widgetsForDays.appendChild(el);
            } else {
            console.log("No such document!");
            // No data for this so default go to creation mode. 
            }
        }  
        
        // Attach this function to the window so it can be called from goToDiary() in script.js
        window.pullDiaryEntryFromFirestore = pullDiaryEntryFromFirestore;

        function extractWidgetData(widgetElement) {
            console.log(widgetElement)
            let widgetData = {}
            
            let intRating = parseInt(widgetElement.querySelector(".starContainer").dataset.currentRating)
            widgetData.rating = intRating != NaN ? intRating  : 0 // Default to 0 stars if something goes wrong. 
            
            // Code for extracting /pictures collection fields
            if (widgetElement.querySelector(".image-widget")) {
                widgetData.widgetType = "picture"
                widgetData.src = widgetElement.querySelector("img").src
                widgetData.photoFrame = "plain" // TODO: get photo frame type

            // Code for extracting /notes collection fields
            } else if (widgetElement.querySelector(".note-widget")) {
                widgetData.widgetType = "note"
                widgetData.value = widgetElement.querySelector("textarea").value
                // Widget Type depends on what class is applied to the note widget. 
                if (widgetElement.querySelector(".notebookPaper")) {
                    widgetData.noteType = "notebookPaper";
                } else if (widgetElement.querySelector(".post-it")) {
                    widgetData.noteType = "post-it"
                } else {
                    widgetData.noteType = "plain"
                }

            // Code for extracting /songs collection fields
            } else if (widgetElement.querySelector(".song-widget")) {
                widgetData.widgetType = "song"
                widgetData.songName = widgetElement.querySelector("input").value
                widgetData.songFrame = "plain"
            }
            return widgetData
        }

        // Push diary entry to firestore for specific day
        async function saveDiaryEntryToFirestore() {
            console.log("Current diary date", currentDiaryDate)
            let allWidgetObjects = []
            // First, loop through all of the elements in the diary entry and extract the widget info. 
            for (let widgetElement of document.getElementById("widgetsForDay").children) {
                // Skip empty widget
                if (widgetElement.classList.contains("emptyWidget")) {
                    continue
                }
                let widgetObject = extractWidgetData(widgetElement)
                console.log(widgetObject)
                allWidgetObjects.push(widgetObject)
            }

            let diaryEntryData = {}
            // Then for each widget, create a new document in the appropriate collection and get the reference.
            let i = 0
            for (let widgetObject of allWidgetObjects) {
                let collectionName = ""
                if (widgetObject.widgetType == "picture") {
                    collectionName = "pictures"
                } else if (widgetObject.widgetType == "note") {
                    collectionName = "notes"
                } else if (widgetObject.widgetType == "song") {
                    collectionName = "songs"
                } else {
                    console.error("Unknown widget type:", widgetObject.widgetType)
                    continue
                }
                // Create a new document in the appropriate collection
                const docRef = await addDoc(collection(db, collectionName), widgetObject);
                console.log("Document written with ID: ", docRef.id);

                // Store the reference for later use in the diary entry
                widgetObject.docRef = docRef
                diaryEntryData[`widget_${i+1}`] = widgetObject.docRef
                i +=1
            }

            // Finally, create or update the diary entry document with the references to each widget.
            await setDoc(doc(db, "diaryEntries", currentDiaryDate), diaryEntryData);
        }
        window.saveDiaryEntryToFirestore = saveDiaryEntryToFirestore;
        document.getElementById("sendToFirestore").addEventListener("click", saveDiaryEntryToFirestore);
    </script>
    <script src="./scripts/script.js"></script>
    <script src="./scripts/populateCalendar.js"></script>
</body>
</HTML>